
# OpenSea Lotto Express

## Описание

OpenSea Lotto Express — сервис для справедливого распределения лотерейных билетов между владельцами NFT/токенов. Новый алгоритм гарантирует, что все билеты всегда распределяются только между владельцами с положительным score, а эффективность распределения всегда 100%.

### Ключевые особенности
- Только владельцы с положительным score получают билеты.
- Все билеты всегда распределяются между валидными владельцами.
- Владельцы с нулевым или отрицательным score не получают ни одного билета.
- Распределение происходит пропорционально score, с учетом псевдослучайной последовательности.
- Если нет валидных владельцев, все билеты остаются нераспределёнными.
- Полное покрытие edge/boundary/unfair кейсов в тестах.

## Быстрый старт через Docker Compose

```sh
cd express
docker compose up -d --build
# первый запуск: миграция схемы
docker compose exec app npx prisma migrate deploy
```

Сервис будет доступен на `http://localhost:8081`, база — на `localhost:5432`.
Для остановки используйте:
```sh
docker compose down
```

### Тесты
Для запуска тестов внутри контейнера:
```sh
docker compose exec app npm run test
```

## Переменные окружения (.env)

## Установка и запуск

```bash
cd express
npm i
npm run dev # разработка
# или
npm run build && npm start # продакшн
```

## Переменные окружения (.env)

```env
PORT=8081
LOG_LEVEL=info
DATABASE_URL=postgresql://user:pass@localhost:5432/opensea_lotto
OPENSEA_API_KEY=
BGL_RPC_URL=
BGL_RPC_USER=
BGL_RPC_PASS=
OPENSEA_COLLECTION_SLUG=bitgesell-road
SEED_MAX_PAGES=50
SEED_PAGE_LIMIT=50
```


## Основные маршруты API

- GET `/` — проверка здоровья
- GET `/info`
- GET `/get_blockchain_data`
- GET `/get_last_winners`
- GET `/get_round`
- GET `/get_lucky_hash`
- GET `/get_tickets_count`
- GET `/get_tickets`
- GET `/get_owners`
- GET `/get_last_trade`
- GET `/get_pages/:limit`
- GET `/nft/:address`

Далее можно постепенно наполнять обработчики логикой, подключать БД и внешние API.

docker compose exec app npx prisma migrate deploy



## Посев и тестовые данные

1) Заполнить `tokens` фиксированным набором nfts:
```bash
curl -X POST http://localhost:8081/init_tokens
```

## Структура проекта
- `src/` — исходный код сервиса
- `src/services/lottery.ts` — основной алгоритм распределения билетов
- `src/__tests__/` — тесты (Jest)
- `Dockerfile`, `docker-compose.yml` — контейнеризация
- `env.sample` — пример переменных окружения

## Описание алгоритма распределения билетов

1. **Фильтрация владельцев:**
  Из списка владельцев отбираются только те, у кого `score > 0`. Владельцы с нулевым или отрицательным score полностью исключаются из распределения.
2. **Определение количества билетов:**
  Количество билетов (`getTicketCount(sum)`) зависит от суммы всех score.
3. **Вычисление веса:**
  Для пропорционального распределения используется вес (`getTicketWeight(sum)`), который корректирует количество билетов для каждого владельца.
4. **Распределение билетов:**
  - Для каждого валидного владельца вычисляется, сколько билетов ему положено (с округлением вниз).
  - Билеты назначаются по псевдослучайной последовательности (чтобы не было зависимости от порядка).
  - Если после основного распределения остались нераспределённые билеты, они равномерно назначаются владельцам с максимальным score.
5. **Результат:**
  - Все билеты всегда распределяются между валидными владельцами.
  - Если нет ни одного валидного владельца, все билеты остаются нераспределёнными (`-1`).

## Авторы
- katelinlis 

